## Задание

### Цель задания

Проверить на практике работу с уровнями изоляции транзакций и увидеть разницу в их работе с данными из разных пользовательских сессий.

Постарайтесь выполнить задание самостоятельно, если какой-то пункт не получится у вас в есть полная инструкция по выполнению работы.

### Пошаговая инструкция

1. Открыть консоль и зайти по ssh на ВМ в ЯО/любое другое подключение
2. Открыть вторую консоль и также зайти по ssh на ту же ВМ в WB cloud или ЯО
3. Запустить везде psql из под пользователя postgres к одному кластеру ПГ
4. Сделать в первой сессии новую таблицу и наполнить ее данными
5. Посмотреть текущий уровень изоляции
6. Начать новую транзакцию в обоех сессиях с дефолтным (не меняя) уровнем изоляции
7. В первой сессии добавить новую запись
8. Сделать запрос на выбор всех записей во второй сессии
9. Видите ли вы новую запись и если да то почему? После задания можете сверить правильный ответ с эталонным
10. Завершить транзакцию в первом окне
11. Сделать запрос на выбор всех записей второй сессии
12. Видите ли вы новую запись и если да то почему?
13. Завершите транзакцию во второй сессии
14. Начать новые транзакции, но уже на уровне repeatable read в ОБЕИХ сессиях
15. В первой сессии добавить новую запись
16. Сделать запрос на выбор всех записей во второй сессии
17. Видите ли вы новую запись и если да то почему?
18. Завершить транзакцию в первом окне
19. Сделать запрос во выбор всех записей второй сессии
20. Видите ли вы новую запись и если да то почему?

## Решение

``` sql
# 3. Запустить везде psql из под пользователя postgres к одному кластеру ПГ

mahalichev@DESKTOP:~$ sudo -u postgres psql
[sudo] password for mahalichev:
psql (17.4 (Ubuntu 17.4-1.pgdg24.04+2))
Type "help" for help.

# 4. Сделать в первой сессии новую таблицу и наполнить ее данными

postgres=# \c wb_psql
wb_psql=# CREATE TABLE task2.products (id serial, name text, price numeric(8, 2), quantity int2);
CREATE TABLE
wb_psql=# INSERT INTO task2.products (name, price, quantity)
wb_psql-# VALUES ('Cucumber', 10.5, 301),
wb_psql-# ('Tomato', 13, 441),
wb_psql-# ('Onion', 5.95, 115);
INSERT 0 3

# 5. Посмотреть текущий уровень изоляции

wb_psql=# SHOW TRANSACTION ISOLATION LEVEL;
 transaction_isolation
-----------------------
 read committed
(1 row)

# 6. Начать новую транзакцию в обоех сессиях с дефолтным (не меняя) уровнем изоляции

wb_psql=# BEGIN;
BEGIN

# 7. В первой сессии добавить новую запись

wb_psql=*# INSERT INTO task2.products (name, price, quantity)
wb_psql-*# VALUES ('Water', 13.45, 1000);
INSERT 0 1

# 8. Сделать запрос на выбор всех записей во второй сессии

wb_psql=*# SELECT * FROM task2.products;
 id |   name   | price | quantity
----+----------+-------+----------
  1 | Cucumber | 10.50 |      301
  2 | Tomato   | 13.00 |      441
  3 | Onion    |  5.95 |      115
(3 rows)

# 9. Видите ли вы новую запись и если да то почему? После задания можете сверить правильный ответ с эталонным

Нет. Уровень изоляции read committed не может видеть неподтвержденные изменения в других транзакциях (предотвращает "грязное чтение").

# 10. Завершить транзакцию в первом окне

wb_psql=*# COMMIT;
COMMIT

# 11. Сделать запрос на выбор всех записей второй сессии

wb_psql=*# SELECT * FROM task2.products;
 id |   name   | price | quantity
----+----------+-------+----------
  1 | Cucumber | 10.50 |      301
  2 | Tomato   | 13.00 |      441
  3 | Onion    |  5.95 |      115
  4 | Water    | 13.45 |     1000
(4 rows)

# 12. Видите ли вы новую запись и если да то почему?

Да. Уровень изоляции read committed допускает "неповторяющееся чтение" - чтение зафиксированных изменений от других транзакций.

# 13. Завершите транзакцию во второй сессии

wb_psql=*# COMMIT;
COMMIT

# 14. Начать новые транзакции, но уже на уровне repeatable read в ОБЕИХ сессиях

wb_psql=# BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
BEGIN

# 15. В первой сессии добавить новую запись

wb_psql=*# INSERT INTO task2.products (name, price, quantity)
wb_psql-*# VALUES ('Apple', 14, 843);
INSERT 0 1

# 16. Сделать запрос на выбор всех записей во второй сессии

wb_psql=*# SELECT * FROM task2.products;
 id |   name   | price | quantity
----+----------+-------+----------
  1 | Cucumber | 10.50 |      301
  2 | Tomato   | 13.00 |      441
  3 | Onion    |  5.95 |      115
  4 | Water    | 13.45 |     1000
(4 rows)

# 17. Видите ли вы новую запись и если да то почему?

Нет. Уровень изоляции repeatable read не может видеть неподтвержденные изменения в других транзакциях (предотвращает "грязное чтение").

# 18. Завершить транзакцию в первом окне

wb_psql=*# COMMIT;
COMMIT

# 19. Сделать запрос во выбор всех записей второй сессии

wb_psql=*# SELECT * FROM task2.products;
 id |   name   | price | quantity
----+----------+-------+----------
  1 | Cucumber | 10.50 |      301
  2 | Tomato   | 13.00 |      441
  3 | Onion    |  5.95 |      115
  4 | Water    | 13.45 |     1000
(4 rows)

# 20. Видите ли вы новую запись и если да то почему?

Нет. Уровень изоляции repeatable read не допускает "неповторяющееся чтение" - чтение зафиксированных изменений от других транзакций.

```

